const NODE_SUFFIX = ""; 

function parseBool(e) {
    return "boolean" == typeof e ? e : "string" == typeof e && ("true" === e.toLowerCase() || "1" === e);
}

function parseNumber(e, t = 0) {
    if (null == e) return t;
    const o = parseInt(e, 10);
    return isNaN(o) ? t : o;
}

function buildFeatureFlags(e) {
    const t = Object.entries({
        loadbalance: "loadBalance",
        ipv6: "ipv6Enabled",
        full: "fullConfig",
        keepalive: "keepAliveEnabled",
        fakeip: "fakeIPEnabled",
        quic: "quicEnabled"
    }).reduce((t, [o, r]) => (t[r] = parseBool(e[o]) || !1, t), {});
    return t.countryThreshold = parseNumber(e.threshold, 0), t;
}

const rawArgs = "undefined" != typeof $arguments ? $arguments : {},
    {
        loadBalance: loadBalance,
        ipv6Enabled: ipv6Enabled,
        fullConfig: fullConfig,
        keepAliveEnabled: keepAliveEnabled,
        fakeIPEnabled: fakeIPEnabled,
        quicEnabled: quicEnabled,
        countryThreshold: countryThreshold
    } = buildFeatureFlags(rawArgs);

function getCountryGroupNames(e, t) {
    return e.filter(e => e.count >= t).map(e => e.country);
}

const PROXY_GROUPS = {
    ACCOUNT: "Account Info",
    MANUAL: "Proxies",
    FALLBACK: "Fallback",
    DIRECT: "Direct",
    CDN: "CDN"
};

// æµé‡ä¿¡æ¯å…³é”®è¯ï¼šå¢žåŠ  â€œé˜²ä¸¢â€
const TRAFFIC_KEYWORDS = /(å»ºè®®|é‡ç½®|å®˜ç½‘|å¥—é¤|æµé‡|å‰©ä½™|åˆ°æœŸ|é˜²ä¸¢|GB|Expire|Usage|Traffic|Standard|Used|Total)/i;
// ç™½åå•ï¼šåŒ…å«ä»¥ä¸‹å­—ç¬¦çš„ä¾ç„¶è§†ä¸ºæ™®é€šèŠ‚ç‚¹
const WHITELIST_KEYWORDS = /(èµžåŠ©|Node|èŠ‚ç‚¹)/i;

function buildBaseLists({ countryGroupNames: o }) {
    const r = [PROXY_GROUPS.FALLBACK, ...o, PROXY_GROUPS.MANUAL, PROXY_GROUPS.DIRECT];
    return {
        defaultProxies: [PROXY_GROUPS.MANUAL, ...o, PROXY_GROUPS.DIRECT],
        defaultProxiesDirect: [PROXY_GROUPS.DIRECT, ...o, PROXY_GROUPS.MANUAL],
        defaultSelector: r,
        defaultFallback: [...o, PROXY_GROUPS.MANUAL, PROXY_GROUPS.DIRECT]
    };
}

const ruleProviders = {
    ADBlock: { type: "http", behavior: "domain", format: "mrs", interval: 86400, url: "https://adrules.top/adrules-mihomo.mrs", path: "./ruleset/ADBlock.mrs" },
    SogouInput: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://ruleset.skk.moe/Clash/non_ip/sogouinput.txt", path: "./ruleset/SogouInput.txt" },
    StaticResources: { type: "http", behavior: "domain", format: "text", interval: 86400, url: "https://ruleset.skk.moe/Clash/domainset/cdn.txt", path: "./ruleset/StaticResources.txt" },
    CDNResources: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://ruleset.skk.moe/Clash/non_ip/cdn.txt", path: "./ruleset/CDNResources.txt" },
    TikTok: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/TikTok.list", path: "./ruleset/TikTok.list" },
    EHentai: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/EHentai.list", path: "./ruleset/EHentai.list" },
    SteamFix: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/SteamFix.list", path: "./ruleset/SteamFix.list" },
    GoogleFCM: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/FirebaseCloudMessaging.list", path: "./ruleset/FirebaseCloudMessaging.list" },
    AdditionalFilter: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/AdditionalFilter.list", path: "./ruleset/AdditionalFilter.list" },
    AdditionalCDNResources: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/AdditionalCDNResources.list", path: "./ruleset/AdditionalCDNResources.list" },
    Crypto: { type: "http", behavior: "classical", format: "text", interval: 86400, url: "https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/Crypto.list", path: "./ruleset/Crypto.list" }
};

const baseRules = [
    "RULE-SET,ADBlock,AdBlock",
    "RULE-SET,AdditionalFilter,AdBlock",
    "RULE-SET,SogouInput,Sogou",
    "DOMAIN-SUFFIX,truthsocial.com,Truth Social",
    "RULE-SET,StaticResources,CDN",
    "RULE-SET,CDNResources,CDN",
    "RULE-SET,AdditionalCDNResources,CDN",
    "RULE-SET,Crypto,Crypto",
    "RULE-SET,EHentai,E-Hentai",
    "RULE-SET,TikTok,TikTok",
    `RULE-SET,SteamFix,${PROXY_GROUPS.DIRECT}`,
    `RULE-SET,GoogleFCM,${PROXY_GROUPS.DIRECT}`,
    `DOMAIN,services.googleapis.cn,${PROXY_GROUPS.MANUAL}`,
    `GEOSITE,GOOGLE-PLAY@CN,${PROXY_GROUPS.DIRECT}`,
    "GEOSITE,CATEGORY-AI-!CN,AI",
    "GEOSITE,TELEGRAM,Telegram",
    "GEOSITE,YOUTUBE,YouTube",
    "GEOSITE,NETFLIX,Netflix",
    "GEOSITE,SPOTIFY,Spotify",
    "GEOSITE,BAHAMUT,Bahamut",
    "GEOSITE,BILIBILI,Bilibili",
    `GEOSITE,MICROSOFT@CN,${PROXY_GROUPS.DIRECT}`,
    "GEOSITE,PIKPAK,PikPak",
    `GEOSITE,GFW,${PROXY_GROUPS.MANUAL}`,
    `GEOSITE,CN,${PROXY_GROUPS.DIRECT}`,
    `GEOSITE,PRIVATE,${PROXY_GROUPS.DIRECT}`,
    "GEOIP,NETFLIX,Netflix,no-resolve",
    "GEOIP,TELEGRAM,Telegram,no-resolve",
    `GEOIP,CN,${PROXY_GROUPS.DIRECT}`,
    `GEOIP,PRIVATE,${PROXY_GROUPS.DIRECT}`,
    "DST-PORT,22,SSH(port 22)",
    `MATCH,${PROXY_GROUPS.MANUAL}`
];

function buildRules({ quicEnabled: e }) {
    const t = [...baseRules];
    return e || t.unshift("AND,((DST-PORT,443),(NETWORK,UDP)),REJECT"), t;
}

const countriesMeta = {
    "Macau": { pattern: "(?i)(æ¾³é—¨|MO|Macau|Macao|ðŸ‡²ðŸ‡´)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Macao.png" },
    "Hong Kong": { pattern: "(?i)(é¦™æ¸¯|HK|Hong Kong|HongKong|hongkong|ðŸ‡­ðŸ‡°)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Hong_Kong.png" },
    "Taiwan": { pattern: "(?i)(å°æ¹¾|TW|Taiwan|æ–°åŒ—|å½°åŒ–|ðŸ‡¹ðŸ‡¼)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Taiwan.png" },
    "Singapore": { pattern: "(?i)(æ–°åŠ å¡|SG|Singapore|ç‹®åŸŽ|ðŸ‡¸ðŸ‡¬)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Singapore.png" },
    "Japan": { pattern: "(?i)(æ—¥æœ¬|JP|Japan|ä¸œäº¬|å¤§é˜ª|åŸ¼çŽ‰|ðŸ‡¯ðŸ‡µ)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Japan.png" },
    "Korea": { pattern: "(?i)(éŸ©å›½|KR|Korea|KOR|é¦–å°”|éŸ“|ðŸ‡°ðŸ‡·)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Korea.png" },
    "United States": { pattern: "(?i)(ç¾Žå›½|US|United States|USA|ðŸ‡ºðŸ‡¸)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/United_States.png" },
    "Canada": { pattern: "(?i)(åŠ æ‹¿å¤§|Canada|ðŸ‡¨ðŸ‡¦)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Canada.png" },
    "United Kingdom": { pattern: "(?i)(è‹±å›½|United Kingdom|UK|ä¼¦æ•¦|London|ðŸ‡¬ðŸ‡§)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/United_Kingdom.png" },
    "Australia": { pattern: "(?i)(æ¾³å¤§åˆ©äºš|æ¾³æ´²|Australia|ðŸ‡¦ðŸ‡º)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Australia.png" },
    "Germany": { pattern: "(?i)(å¾·å›½|Germany|ðŸ‡©ðŸ‡ª)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Germany.png" },
    "France": { pattern: "(?i)(æ³•å›½|France|ðŸ‡«ðŸ‡·)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/France.png" },
    "Russia": { pattern: "(?i)(ä¿„ç½—æ–¯|RU|Russia|ðŸ‡·ðŸ‡º)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Russia.png" },
    "Thailand": { pattern: "(?i)(æ³°å›½|Thailand|ðŸ‡¹ðŸ‡­)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Thailand.png" },
    "Netherlands": { pattern: "(?i)(è·å…°|Netherlands|Holland|ðŸ‡³ðŸ‡±)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Netherlands.png" },
    "India": { pattern: "(?i)(å°åº¦|India|ðŸ‡®ðŸ‡³)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/India.png" },
    "Malaysia": { pattern: "(?i)(é©¬æ¥è¥¿äºš|Malaysia|ðŸ‡²ðŸ‡¾)", icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Malaysia.png" }
};

function parseCountries(realProxyNames) {
    const r = Object.create(null);
    const countryOrder = Object.keys(countriesMeta);
    const n = {};
    for (const e of countryOrder) n[e] = new RegExp(countriesMeta[e].pattern.replace(/^\(\?i\)/, ""), "i");
    
    for (const t of realProxyNames) {
        for (const e of countryOrder) {
            if (n[e].test(t)) {
                r[e] = (r[e] || 0) + 1;
                break;
            }
        }
    }
    return Object.entries(r).map(([e, t]) => ({ country: e, count: t }));
}

function buildCountryProxyGroups({ countries: e, loadBalance: o }) {
    const r = [],
        s = o ? "load-balance" : "url-test";
    for (const l of e) {
        const e = countriesMeta[l];
        if (!e) continue;
        const i = {
            name: l,
            icon: e.icon,
            "include-all": !0,
            filter: e.pattern,
            "exclude-filter": TRAFFIC_KEYWORDS.source, 
            type: s
        };
        o || Object.assign(i, { url: "https://cp.cloudflare.com/generate_204", interval: 60, tolerance: 20, lazy: !1 });
        r.push(i);
    }
    return r;
}

function buildProxyGroups({ countries: t, countryProxyGroups: o, defaultProxies: n, defaultProxiesDirect: s, defaultFallback: i, trafficNodes: trafficNodes, realProxyNames: realProxyNames }) {
    const hasTW = t.includes("Taiwan"),
          hasHK = t.includes("Hong Kong"),
          hasUS = t.includes("United States");

    const groups = [{
        name: PROXY_GROUPS.MANUAL,
        icon: "https://fastly.jsdelivr.net/gh/shindgewongxj/WHATSINStash@master/icon/select.png",
        type: "select",
        proxies: realProxyNames 
    }];

    if (trafficNodes.length > 0) {
        groups.push({
            name: PROXY_GROUPS.ACCOUNT,
            // å·²æ›´æ¢ä¸ºæŒ‡å®šçš„ TestFlight å›¾æ ‡
            icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/TestFlight.png",
            type: "select",
            proxies: trafficNodes
        });
    }

    groups.push({
        name: PROXY_GROUPS.FALLBACK,
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Bypass.png",
        type: "fallback",
        url: "https://cp.cloudflare.com/generate_204",
        proxies: i,
        interval: 180,
        tolerance: 20,
        lazy: !1
    });

    const commonGroups = [{
        name: "CDN",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Cloudflare.png",
        type: "select",
        proxies: n
    }, {
        name: "AI",
        icon: "https://fastly.jsdelivr.net/gh/powerfullz/override-rules@master/icons/chatgpt.png",
        type: "select",
        proxies: n
    }, {
        name: "Telegram",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Telegram.png",
        type: "select",
        proxies: n
    }, {
        name: "YouTube",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/YouTube.png",
        type: "select",
        proxies: n
    }, {
        name: "Bilibili",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/bilibili.png",
        type: "select",
        proxies: hasTW && hasHK ? [PROXY_GROUPS.DIRECT, "Taiwan", "Hong Kong"] : s
    }, {
        name: "Netflix",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Netflix.png",
        type: "select",
        proxies: n
    }, {
        name: "Spotify",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Spotify.png",
        type: "select",
        proxies: n
    }, {
        name: "TikTok",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/TikTok.png",
        type: "select",
        proxies: n
    }, {
        name: "E-Hentai",
        icon: "https://fastly.jsdelivr.net/gh/powerfullz/override-rules@master/icons/Ehentai.png",
        type: "select",
        proxies: n
    }, {
        name: "PikPak",
        icon: "https://fastly.jsdelivr.net/gh/powerfullz/override-rules@master/icons/PikPak.png",
        type: "select",
        proxies: n
    }, {
        name: "Truth Social",
        icon: "https://fastly.jsdelivr.net/gh/powerfullz/override-rules@master/icons/TruthSocial.png",
        type: "select",
        proxies: hasUS ? ["United States", PROXY_GROUPS.MANUAL] : n
    }, {
        name: "Bahamut",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Bahamut.png",
        type: "select",
        proxies: hasTW ? ["Taiwan", PROXY_GROUPS.MANUAL, PROXY_GROUPS.DIRECT] : n
    }, {
        name: "Crypto",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Cryptocurrency_3.png",
        type: "select",
        proxies: n
    }, {
        name: "SSH(port 22)",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Server.png",
        type: "select",
        proxies: n
    }, {
        name: "Sogou",
        icon: "https://fastly.jsdelivr.net/gh/powerfullz/override-rules@master/icons/Sougou.png",
        type: "select",
        proxies: [PROXY_GROUPS.DIRECT, "REJECT"]
    }, {
        name: PROXY_GROUPS.DIRECT,
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Direct.png",
        type: "select",
        proxies: ["DIRECT", PROXY_GROUPS.MANUAL]
    }, {
        name: "AdBlock",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/AdBlack.png",
        type: "select",
        proxies: ["REJECT", "REJECT-DROP", PROXY_GROUPS.DIRECT]
    }];

    return [...groups, ...commonGroups, ...o].filter(Boolean);
}

function main(e) {
    const proxies = e.proxies || [];
    
    // è¯†åˆ«é€»è¾‘ï¼šåŒ…å«å…³é”®è¯ ä¸” ä¸åŒ…å«èµžåŠ©ç™½åå•
    const trafficNodes = proxies
        .filter(p => TRAFFIC_KEYWORDS.test(p.name) && !WHITELIST_KEYWORDS.test(p.name))
        .map(p => p.name);

    // è¯†åˆ«çœŸå®žä»£ç†
    const realProxyNames = proxies
        .filter(p => !TRAFFIC_KEYWORDS.test(p.name) || WHITELIST_KEYWORDS.test(p.name))
        .map(p => p.name);
    
    const t = { proxies: proxies };
    const o = parseCountries(realProxyNames);
    const n = getCountryGroupNames(o, countryThreshold);

    const { defaultProxies: l, defaultProxiesDirect: i, defaultSelector: a, defaultFallback: c } = buildBaseLists({ countryGroupNames: n });
    const p = buildCountryProxyGroups({ countries: n, loadBalance: loadBalance });
    const u = buildProxyGroups({ 
        countries: n, 
        countryProxyGroups: p, 
        defaultProxies: l, 
        defaultProxiesDirect: i, 
        defaultFallback: c,
        trafficNodes: trafficNodes,
        realProxyNames: realProxyNames
    });
    
    const groupNames = u.map(e => e.name);
    u.push({
        name: "GLOBAL",
        icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure@master/IconSet/Color/Global.png",
        "include-all": !0,
        type: "select",
        proxies: groupNames
    });

    const g = buildRules({ quicEnabled: quicEnabled });
    
    if (fullConfig) {
        Object.assign(t, {
            "mixed-port": 7890,
            "allow-lan": !0,
            ipv6: ipv6Enabled,
            mode: "rule",
            "unified-delay": !0,
            "tcp-concurrent": !0,
            "log-level": "info",
            "external-controller": ":9999",
            profile: { "store-selected": !0 }
        });
    }

    return Object.assign(t, { 
        "proxy-groups": u, 
        "rule-providers": ruleProviders, 
        rules: g, 
        dns: fakeIPEnabled ? { enable: true, "enhanced-mode": "fake-ip", nameserver: ["223.5.5.5", "119.29.29.29"] } : { enable: true, "enhanced-mode": "redir-host", nameserver: ["system"] }
    }), t;
}
